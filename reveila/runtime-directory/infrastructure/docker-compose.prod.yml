services:
  # The Agentic AI Runtime Fabric
  reveila-fabric:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: reveila-fabric-prod
    environment:
      - REVEILA_HOME=/reveila
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=reveila-db-prod
      - DB_USER=charles
      - DB_PASSWORD=reveila_secure_pass
    ports:
      - "8080:8080"
    volumes:
      # Map sibling folders into the container root
      - ../bin:/reveila/bin:ro
      - ../libs:/reveila/libs:ro
      - ../configs:/reveila/configs:ro
      - ../resources:/reveila/resources:ro
      - ../data:/reveila/data:rw
      - ../logs:/reveila/logs:rw
      - ../plugins:/reveila/plugins:ro
    depends_on:
      reveila-db-prod:
        condition: service_healthy

  # The Sovereign Data Node (Postgres)
  reveila-db-prod:
    image: postgres:15-alpine
    container_name: reveila-db-prod
    environment:
      - POSTGRES_USER=charles
      - POSTGRES_PASSWORD=reveila_secure_pass
      - POSTGRES_DB=reveila_db
    volumes:
      # Map DB files to the sovereign data silo
      - ../data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U charles -d reveila_db"]
      interval: 5s
      timeout: 5s
      retries: 5